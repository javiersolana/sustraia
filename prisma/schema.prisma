generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String             @id @default(cuid())
  email                 String             @unique
  password              String
  name                  String
  role                  UserRole
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  coachId               String?
  weeklyGoalKm          Float?
  birthDate             DateTime?
  maxHeartRate          Int?
  restingHR             Int?
  athleteGoals          AthleteGoal[]      @relation("AthleteGoals")
  coachGoals            AthleteGoal[]      @relation("CoachGoals")
  athleteNotes          AthleteNote[]      @relation("AthleteNotes")
  coachNotes            AthleteNote[]      @relation("CoachNotes")
  completedWorkouts     CompletedWorkout[]
  sentMessages          Message[]          @relation("SentMessages")
  receivedMessages      Message[]          @relation("ReceivedMessages")
  stats                 Stat[]
  stravaToken           StravaToken?
  coach                 User?              @relation("CoachAthletes", fields: [coachId], references: [id])
  athletes              User[]             @relation("CoachAthletes")
  assignedWorkouts      Workout[]          @relation("AssignedWorkouts")
  workouts              Workout[]
  coachTrainingPlans    TrainingPlan[]     @relation("CoachTrainingPlans")
  athleteTrainingPlans  TrainingPlan[]     @relation("AthleteTrainingPlans")
  passwordResetTokens   PasswordResetToken[]
  // Achievements
  achievements          UserAchievement[]
  // Community groups
  createdGroups         AccountabilityGroup[] @relation("GroupCreator")
  groupMemberships      GroupMember[]
  groupMessages         GroupMessage[]

  @@index([email])
  @@index([role])
}

model Workout {
  id               String            @id @default(cuid())
  userId           String
  assignedTo       String?
  date             DateTime
  type             WorkoutType
  title            String
  description      String?
  distance         Float?
  duration         Int?
  intensity        String?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  completedVersion CompletedWorkout?
  athlete          User?             @relation("AssignedWorkouts", fields: [assignedTo], references: [id])
  creator          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assignedTo])
  @@index([date])
}

model CompletedWorkout {
  id                         String       @id @default(cuid())
  workoutId                  String?      @unique
  userId                     String
  title                      String?
  label                      WorkoutLabel @default(OTRO)
  completedAt                DateTime     @default(now())
  actualDuration             Int?
  actualDistance             Float?
  avgHeartRate               Int?
  maxHeartRate               Int?
  calories                   Int?
  feeling                    String?
  notes                      String?
  stravaId                   String?      @unique
  stravaType                 String?
  workoutStructure           Json?
  classificationConfidence   String?
  humanReadable              String?
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @updatedAt
  user                       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout                    Workout?     @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completedAt])
  @@index([stravaId])
  @@index([label])
}

model Message {
  id        String   @id @default(cuid())
  fromId    String
  toId      String
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  from      User     @relation("SentMessages", fields: [fromId], references: [id], onDelete: Cascade)
  to        User     @relation("ReceivedMessages", fields: [toId], references: [id], onDelete: Cascade)

  @@index([fromId])
  @@index([toId])
  @@index([read])
  @@index([createdAt])
}

model Stat {
  id         String   @id @default(cuid())
  userId     String
  metricName String
  value      Float
  date       DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, metricName, date])
  @@index([userId])
  @@index([metricName])
  @@index([date])
}

model StravaToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scope        String
  athleteId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AthleteNote {
  id        String   @id @default(cuid())
  coachId   String
  athleteId String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  athlete   User     @relation("AthleteNotes", fields: [athleteId], references: [id], onDelete: Cascade)
  coach     User     @relation("CoachNotes", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([athleteId])
  @@index([createdAt])
}

model AthleteGoal {
  id          String   @id @default(cuid())
  athleteId   String
  coachId     String?
  date        DateTime
  name        String
  distance    Float?
  description String?
  type        String   @default("race")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  athlete     User     @relation("AthleteGoals", fields: [athleteId], references: [id], onDelete: Cascade)
  coach       User?    @relation("CoachGoals", fields: [coachId], references: [id])

  @@index([athleteId])
  @@index([coachId])
  @@index([date])
}

model TrainingPlan {
  id          String          @id @default(cuid())
  coachId     String
  athleteId   String
  date        DateTime
  title       String
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  coach       User            @relation("CoachTrainingPlans", fields: [coachId], references: [id], onDelete: Cascade)
  athlete     User            @relation("AthleteTrainingPlans", fields: [athleteId], references: [id], onDelete: Cascade)
  blocks      TrainingBlock[]

  @@index([coachId])
  @@index([athleteId])
  @@index([date])
}

model TrainingBlock {
  id              String        @id @default(cuid())
  planId          String
  order           Int
  type            String
  durationSeconds Int?
  distanceMeters  Float?
  repetitions     Int?
  restSeconds     Int?
  paceMin         Float?
  paceMax         Float?
  hrMin           Int?
  hrMax           Int?
  targetType      String?
  targetMin       Float?
  targetMax       Float?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  plan            TrainingPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([order])
}

enum UserRole {
  ATLETA
  COACH
  ADMIN
}

enum WorkoutType {
  RUN
  RIDE
  SWIM
  STRENGTH
  YOGA
  OTHER
}

enum WorkoutLabel {
  CALENTAMIENTO
  DESCALENTAMIENTO
  FUERZA
  SERIES
  TEMPO
  RODAJE
  CUESTAS
  OTRO
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================================================
// ACHIEVEMENT SYSTEM (Quick Wins - Medals)
// ============================================================================

model Achievement {
  id          String              @id @default(cuid())
  code        String              @unique // e.g., "STREAK_60", "FIRST_10K"
  name        String              // "60 DÃ­as de Constancia"
  description String
  icon        String              // emoji or icon name
  category    AchievementCategory
  threshold   Int?                // numeric threshold (e.g., 60 for streak)
  createdAt   DateTime            @default(now())

  userAchievements UserAchievement[]
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  earnedAt      DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

enum AchievementCategory {
  STREAK     // Consistency
  DISTANCE   // Distance milestones
  WORKOUT    // Workout count
  COMMUNITY  // Social achievements
  SPECIAL    // One-time events
}

// ============================================================================
// ACCOUNTABILITY GROUPS (Cuadrilla Community)
// ============================================================================

model AccountabilityGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  creatorId   String
  inviteCode  String   @unique @default(cuid())
  weeklyGoal  Int      @default(4) // workouts per week
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User          @relation("GroupCreator", fields: [creatorId], references: [id])
  members     GroupMember[]
  messages    GroupMessage[]

  @@index([creatorId])
  @@index([inviteCode])
}

model GroupMember {
  id        String    @id @default(cuid())
  groupId   String
  userId    String
  role      GroupRole @default(MEMBER)
  joinedAt  DateTime  @default(now())

  group AccountabilityGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model GroupMessage {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  content   String
  createdAt DateTime @default(now())

  group AccountabilityGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([userId])
  @@index([createdAt])
}

enum GroupRole {
  CREATOR
  ADMIN
  MEMBER
}
