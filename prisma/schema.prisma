generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  name              String
  role              UserRole
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  coachId           String?
  weeklyGoalKm      Float?
  birthDate         DateTime?
  maxHeartRate      Int?
  restingHR         Int?
  athleteGoals      AthleteGoal[]      @relation("AthleteGoals")
  coachGoals        AthleteGoal[]      @relation("CoachGoals")
  athleteNotes      AthleteNote[]      @relation("AthleteNotes")
  coachNotes        AthleteNote[]      @relation("CoachNotes")
  completedWorkouts CompletedWorkout[]
  sentMessages      Message[]          @relation("SentMessages")
  receivedMessages  Message[]          @relation("ReceivedMessages")
  stats             Stat[]
  stravaToken       StravaToken?
  coach             User?              @relation("CoachAthletes", fields: [coachId], references: [id])
  athletes          User[]             @relation("CoachAthletes")
  assignedWorkouts  Workout[]          @relation("AssignedWorkouts")
  workouts          Workout[]

  @@index([email])
  @@index([role])
}

model Workout {
  id               String            @id @default(cuid())
  userId           String
  assignedTo       String?
  date             DateTime
  type             WorkoutType
  title            String
  description      String?
  distance         Float?
  duration         Int?
  intensity        String?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  completedVersion CompletedWorkout?
  athlete          User?             @relation("AssignedWorkouts", fields: [assignedTo], references: [id])
  creator          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assignedTo])
  @@index([date])
}

model CompletedWorkout {
  id             String       @id @default(cuid())
  workoutId      String?      @unique
  userId         String
  title          String?
  label          WorkoutLabel @default(OTRO)
  completedAt    DateTime     @default(now())
  actualDuration Int?
  actualDistance Float?
  avgHeartRate   Int?
  maxHeartRate   Int?
  calories       Int?
  feeling        String?
  notes          String?
  stravaId       String?      @unique
  stravaType     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout        Workout?     @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completedAt])
  @@index([stravaId])
  @@index([label])
}

model Message {
  id        String   @id @default(cuid())
  fromId    String
  toId      String
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  from      User     @relation("SentMessages", fields: [fromId], references: [id], onDelete: Cascade)
  to        User     @relation("ReceivedMessages", fields: [toId], references: [id], onDelete: Cascade)

  @@index([fromId])
  @@index([toId])
  @@index([read])
  @@index([createdAt])
}

model Stat {
  id         String   @id @default(cuid())
  userId     String
  metricName String
  value      Float
  date       DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, metricName, date])
  @@index([userId])
  @@index([metricName])
  @@index([date])
}

model StravaToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scope        String
  athleteId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AthleteNote {
  id        String   @id @default(cuid())
  coachId   String
  athleteId String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  athlete   User     @relation("AthleteNotes", fields: [athleteId], references: [id], onDelete: Cascade)
  coach     User     @relation("CoachNotes", fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([athleteId])
  @@index([createdAt])
}

model AthleteGoal {
  id          String   @id @default(cuid())
  athleteId   String
  coachId     String?
  date        DateTime
  name        String
  distance    Float?
  description String?
  type        String   @default("race")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  athlete     User     @relation("AthleteGoals", fields: [athleteId], references: [id], onDelete: Cascade)
  coach       User?    @relation("CoachGoals", fields: [coachId], references: [id])

  @@index([athleteId])
  @@index([coachId])
  @@index([date])
}

enum UserRole {
  ATLETA
  COACH
  ADMIN
}

enum WorkoutType {
  RUN
  RIDE
  SWIM
  STRENGTH
  YOGA
  OTHER
}

enum WorkoutLabel {
  CALENTAMIENTO
  DESCALENTAMIENTO
  FUERZA
  SERIES
  TEMPO
  RODAJE
  CUESTAS
  OTRO
}
